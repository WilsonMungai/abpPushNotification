<html>
<head>
<script 
  src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"
  type="text/javascript">
</script>
</head>

<body>
<script>
ThunkableWebviewerExtension.receiveMessage(async function(message) {
  try {
    const input = JSON.parse(message);
    const { date, heading, title, reminderName, playerID, appID, authKey } = input;

    // ✅ Validate required fields
    if (!date || !heading || !title || !reminderName || !playerID || !appID || !authKey) {
      throw new Error("Missing required fields: date, heading, title, reminderName, playerID, appID, authKey");
    }

    // ✅ Create local datetime at 8 AM
    const localDateTime = new Date(`${date}T08:00:00`);
    if (isNaN(localDateTime)) throw new Error("Invalid date format. Use YYYY-MM-DD");

    // ✅ Convert local time to UTC ISO string for OneSignal
    const utcDateTime = localDateTime.toISOString();

    // ✅ If time has already passed, send immediately
    const now = new Date();
    const sendNow = localDateTime < now;

    // ✅ Build OneSignal payload
    const payload = {
      app_id: appID,
      include_player_ids: [playerID],
      name: reminderName,               // Internal name for dashboard
      headings: { en: heading },        // Dynamic title from user input
      contents: { en: title },          // Notification message/body
    };

    // ✅ Add scheduling only if in the future
    if (!sendNow) payload.send_after = utcDateTime;

    // ✅ Send the request to OneSignal
    const response = await fetch("https://api.onesignal.com/notifications", {
      method: "POST",
      headers: {
        "Content-Type": "application/json; charset=utf-8",
        "Authorization": `Basic ${authKey}`,
        "accept": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    // ✅ Send success response back to Thunkable
    ThunkableWebviewerExtension.postMessage(JSON.stringify({
      success: true,
      scheduledFor: sendNow ? "Now" : utcDateTime,
      response: result
    }));

  } catch (error) {
    ThunkableWebviewerExtension.postMessage(JSON.stringify({
      success: false,
      error: error.message
    }));
  }
});
</script>
</body>
</html>