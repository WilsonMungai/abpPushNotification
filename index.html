<html>
<head>
<script 
  src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"
  type="text/javascript">
</script>
</head>

<body>
<script>
ThunkableWebviewerExtension.receiveMessage(async function(message) {
  try {
    const input = JSON.parse(message);
    const { date, title, playerID, appID, authKey } = input;

    // ✅ Basic validation
    if (!date || !title || !playerID || !appID || !authKey) {
      throw new Error("Missing required fields: date, title, playerID, appID, authKey");
    }

    // ✅ Create local date with 8 AM time
    // The user’s local timezone is automatically applied by JavaScript
    const localDateTime = new Date(`${date}T08:00:00`);

    if (isNaN(localDateTime)) throw new Error("Invalid date format. Use YYYY-MM-DD");

    // ✅ Convert to ISO UTC time for OneSignal
    const utcDateTime = localDateTime.toISOString(); // e.g. 2025-10-25T14:00:00.000Z (if user in UTC+6)

    // ✅ Prepare payload for OneSignal
    const payload = {
      app_id: appID,
      include_player_ids: [playerID],
      headings: { en: "Reminder" },
      contents: { en: title },
      send_after: utcDateTime
    };

    // ✅ Send request to OneSignal
    const response = await fetch("https://api.onesignal.com/notifications", {
      method: "POST",
      headers: {
        "Content-Type": "application/json; charset=utf-8",
        "Authorization": `Basic ${authKey}`,
        "accept": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    // ✅ Send response back to Thunkable
    ThunkableWebviewerExtension.postMessage(JSON.stringify({
      success: true,
      utcScheduledTime: utcDateTime,
      response: result
    }));

  } catch (error) {
    ThunkableWebviewerExtension.postMessage(JSON.stringify({
      success: false,
      error: error.message
    }));
  }
});
</script>
</body>
</html>