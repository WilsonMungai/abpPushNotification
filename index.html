<html>
<head>
  <script 
    src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"
    type="text/javascript">
  </script>
</head>

<body>
<script>
/**
 * Helper function to parse flexible date inputs like:
 * - "Oct 15, 2025"
 * - "October 15 2025"
 * - "2025-10-15"
 */
function parseUserDate(input) {
  let d = new Date(input);
  if (!isNaN(d)) return d;

  // Try parsing manually if the default Date parser fails
  const parts = input.replace(",", "").split(" ");
  if (parts.length === 3) {
    const [month, day, year] = parts;
    d = new Date(`${month} ${parseInt(day)}, ${year}`);
  }

  if (isNaN(d)) throw new Error("Invalid date format. Use 'Oct 15, 2025'.");
  return d;
}

// Listen for messages from Thunkable
ThunkableWebviewerExtension.receiveMessage(async function(message) {
  try {
    let input;
    try {
      input = JSON.parse(message);
    } catch {
      throw new Error("Invalid JSON format sent from Thunkable.");
    }

    const { date, heading, title, reminderName, playerID, appID, authKey } = input;

    // ✅ Basic field validation
    if (!date || !heading || !title || !reminderName || !playerID || !appID || !authKey) {
      throw new Error("Missing required fields: date, heading, title, reminderName, playerID, appID, authKey");
    }

    // ✅ Parse and normalize the date
    const parsedDate = parseUserDate(date);
    parsedDate.setHours(8, 0, 0, 0); // Set to 8 AM local time

    // ✅ Convert local 8 AM to UTC (OneSignal requires ISO 8601)
    const utcDateTime = parsedDate.toISOString();

    // ✅ Check if the date/time is in the past
    const now = new Date();
    const sendNow = parsedDate < now;

    // ✅ Build the OneSignal payload
    const payload = {
      app_id: appID,
      include_player_ids: [playerID],
      name: reminderName,          // Internal label (not shown to users)
      headings: { en: heading },   // Notification title
      contents: { en: title },     // Notification message body
    };

    // Schedule for future delivery or send immediately if past
    if (!sendNow) {
      payload.send_after = utcDateTime; // Schedule for 8 AM UTC equivalent
    }

    // ✅ Send POST request to OneSignal
    const response = await fetch("https://api.onesignal.com/notifications", {
      method: "POST",
      headers: {
        "Content-Type": "application/json; charset=utf-8",
        "Authorization": `Basic ${authKey}`,
        "accept": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    // Handle OneSignal API errors
    if (!response.ok) {
      throw new Error(`OneSignal error: ${JSON.stringify(result.errors || result)}`);
    }

    // ✅ Return success result to Thunkable
    ThunkableWebviewerExtension.postMessage(JSON.stringify({
      success: true,
      scheduledFor: sendNow ? "Sent immediately" : utcDateTime,
      response: result
    }));

  } catch (error) {
    // ✅ Return error message to Thunkable
    ThunkableWebviewerExtension.postMessage(JSON.stringify({
      success: false,
      error: error.message
    }));
  }
});
</script>
</body>
</html>