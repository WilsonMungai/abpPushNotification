<html>
<head>
<script 
  src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"
  type="text/javascript">
</script>
</head>

<body>
<script>
ThunkableWebviewerExtension.receiveMessage(async function(message) {
  try {
    const input = JSON.parse(message);
    const { date, heading, title, reminderName, playerID, appID, authKey } = input;

    // Basic validation
    if (!date || !heading || !title || !reminderName || !playerID || !appID || !authKey) {
      throw new Error("Missing required fields: date, heading, title, reminderName, playerID, appID, authKey");
    }

    // Parse the date string like "Oct 15, 2025"
    let parsedDate = new Date(date);
    if (isNaN(parsedDate)) {
      throw new Error("Invalid date format. Use 'MMM DD, YYYY' (e.g., 'Oct 15, 2025').");
    }

    // Set time to 8 AM local time
    parsedDate.setHours(8, 0, 0, 0);

    // Convert to UTC ISO format for OneSignal
    const utcDateTime = parsedDate.toISOString();

    // Check if the time is in the past
    const now = new Date();
    const sendNow = parsedDate < now;

    // Build the OneSignal payload
    const payload = {
      app_id: appID,
      include_player_ids: [playerID],
      name: reminderName,
      headings: { en: heading },
      contents: { en: title },
    };

    // Schedule if future, send immediately if past
    if (!sendNow) payload.send_after = utcDateTime;

    // Send request to OneSignal
    const response = await fetch("https://api.onesignal.com/notifications", {
      method: "POST",
      headers: {
        "Content-Type": "application/json; charset=utf-8",
        "Authorization": `Basic ${authKey}`,
        "accept": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    // Send success result back to Thunkable
    ThunkableWebviewerExtension.postMessage(JSON.stringify({
      success: true,
      scheduledFor: sendNow ? "Now" : utcDateTime,
      response: result
    }));

  } catch (error) {
    ThunkableWebviewerExtension.postMessage(JSON.stringify({
      success: false,
      error: error.message
    }));
  }
});
</script>
</body>
</html>